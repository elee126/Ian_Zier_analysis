---
title: "Zier_comparison_analysis"
author: "Emma"
date: "12/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(ggplot2)
library(knitr)
library(kableExtra)
library(lubridate)
library(tableone)
library(forcats)
library(stringr)
library(janitor)
library(dplyr)
library(qwraps2)
library(plyr)
library(ggridges)
library(viridis)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(data.table)
options(qwraps2_markup = "markdown")
```

## Read in COPD data
```{r read_copd }

copd_data <- read_csv(here::here("Data", "20191021_Qualtrics data.csv"))
copd_codebook <- read_csv(here::here("Data", "20191014_Qualtrics codebook.csv"), skip = 1)

copd_codebook <- copd_codebook[, -1]
prefcols <- as.character(copd_codebook[1, ])
colnames(copd_data)<-prefcols
colnames(copd_codebook)<-prefcols
rm(prefcols)
copd_data <- copd_data[-2, ]
copd_data <- copd_data[-1, ]
rownames(copd_codebook)<-c("var", "description", "scoring")

# Subset dataset for figs 
# Select the variables and order them from lowest survival to highest 
zier_vars <- c("zier_1", "zier_2", "zier_3", "zier_4", "zier_5", "zier_6", "zier_7", "zier_8", "zier_9", "zier_10", "zier_11", "zier_12", "zier_13", "zier_14", "zier_15", "zier_16")
zier_vars <- rev(zier_vars)

# Gather the data 
copd_tbl <- copd_data %>% 
  dplyr::select(zier_vars) %>% 
  gather() %>% 
  mutate(key = factor(key, levels = zier_vars)) %>% 
  mutate(value = as.numeric(value)) %>% 
  filter(complete.cases(value))

# Clean up
rm(prefcols)

```

## Read in Zier original data 
```{r read_zier }

zier_data <- read_csv(here::here("Data", "20191220_Zier Data.csv"))
zier_codebook <- read_csv(here::here("Data", "20191223_Zier codebook.csv"), skip = 1)

zier_codebook <- zier_codebook[, -1]
prefcols2 <- as.character(zier_codebook[1, ])
colnames(zier_data) <- prefcols2 
colnames(zier_codebook) <- prefcols2 
rm(prefcols2) 
rownames(zier_codebook) <- c("var", "description")

# Subset dataset for figs
zier_tbl <- zier_data %>% 
  dplyr::select(zier_vars) %>% 
  gather() %>% 
  mutate(key = factor(key, levels = zier_vars)) %>% 
  mutate(value = as.numeric(value)) %>% 
  filter(complete.cases(value))

# Clean up 
rm(prefcols2)

```


## Set UID for COPD data (copd_data)
```{r uid}

a<-dim(copd_data)[1]

copd_data <- copd_data %>%
  mutate(uid=(1:a))

rm(a)

```

# COPD & ZIER Ridge Plots
```{r ridge_plots}

# n for each statement
copd_counts <- copd_tbl %>% 
  filter(is.na(value) == FALSE) %>%
  group_by(key) %>% 
  tally()

zier_counts <- zier_tbl %>% 
  filter(is.na(value) == FALSE) %>%
  group_by(key) %>% 
  tally()

copd_counts
zier_counts

# COPD ridge plot
copd_ridge <- copd_tbl %>% 
  
  ggplot(aes(x = value, y = key, fill = ..x.., vline_color = ..quantile..)) + 
  
  geom_density_ridges_gradient(bandwidth = 3, scale = 2, color = "white", 
                               quantile_lines = TRUE, vline_size = 1.25) + 
  
   scale_discrete_manual("vline_color", 
                        values = c("green", "red", "green", "white"), guide = "none") + 
  
  scale_discrete_manual("vlineTypes", 
                        values = c("dashed", "solid", "dashed", "dotted"), guide = "none") + 

  scale_x_continuous(limits = c(0, 100)) + 
  
  scale_fill_viridis(name = "Likelihood of survival", option = "C") + 
  
  labs(title = "COPD Population: Comparison of survival estimates between prognostic statements", 
       x = "Likelihood of survival (%)", 
       y = "Prognostic statement") + 
  scale_y_discrete(labels = c("He will definitely not survive. (n=58)", "He has a 5% chance of surviving. (n=53)", "It is unlikely he will survive. That means he will likely die. (n=57)", "It is very likely he will die. (n=54)", "It is very unlikely he will survive. (n=57)", "I don't think he will survive. (n=57)", "He probably will not survive. (n=58)", "It is possible he will not survive. (n=52)", "I am concerned he will not survive. (n=54)", "He has a 50% chance of surviving. (n=56)", "I am optimistic he will survive. (n=59)", "It is very unlikely he will die. (n=56)", "I think he will survive. (n=57)", "It is very likely he will survive. (n=57)", "He has a 90% chance of surviving. (n=62)", "He will definitely survive. (n=59)")) +
  
  theme_bw() 

copd_rige

# ZIER Ridge 
zier_ridge <- zier_tbl %>% 
  ggplot(aes(x = value, y = key, fill = ..x.., vline_color = ..quantile..)) + 
  geom_density_ridges_gradient(bandwidth = 3, scale = 2, color = "white", 
                               quantile_lines = TRUE, vline_size = 1.25) + 
   scale_discrete_manual("vline_color", 
                        values = c("pink", "red", "pink", "white"), guide = "none") + 
  scale_discrete_manual("vlineTypes", 
                        values = c("dashed", "solid", "dashed", "dotted"), guide = "none") + 
  scale_x_continuous(limits = c(0, 100)) + 
  scale_fill_viridis(name = "Likelihood of survival", option = "D") + 
  labs(title = "ZIER Population: Comparison of survival estimates between prognostic statements", 
       x = "Likelihood of survival (%)", 
       y = "Prognostic statement") +
  scale_y_discrete(labels = c("He will definitely not survive. (n=79)", "He has a 5% chance of surviving. (n=80)", "It is unlikely he will survive. That means he will likely die. (n=80)", "It is very likely he will die. (n=80)", "It is very unlikely he will survive. (n=80)", "I don't think he will survive. (n=80)", "He probably will not survive. (n=80)", "It is possible he will not survive. (n=80)", "I am concerned he will not survive. (n=80)", "He has a 50% chance of surviving. (n=80)", "I am optimistic he will survive. (n=80)", "It is very unlikely he will die. (n=80)", "I think he will survive. (n=78)", "It is very likely he will survive. (n=80)", "He has a 90% chance of surviving. (n=80)", "He will definitely survive. (n=80)")) + 
  theme_bw()

zier_ridge

```

# COPD Zier Box Plot
```{r copd_box }

copd_box <- copd_tbl %>% 
  ggplot(aes(x = key, y = value)) + 
  geom_boxplot(fill = "orchid1") + 
  coord_flip() +
  scale_y_continuous(limits = c(0, 100)) + 
  labs(title = "Comparison of survival estimates between prognostic statements \n\n Outpatient Proxy Sample (Qualtrics COPD)", 
       y = "Likelihood of survival (%)", 
       x = "Prognostic statement") + 
  scale_x_discrete(labels = c("He will definitely not survive.", "He has a 5% chance of surviving.", "It is unlikely he will survive. That means he will likely die.", "It is very likely he will die.", "It is very unlikely he will survive.", "I don't think he will survive.", "He probably will not survive.", "It is possible he will not survive.", "I am concerned he will not survive.", "He has a 50% chance of surviving.", "I am optimistic he will survive.", "It is very unlikely he will die.", "I think he will survive.", "It is very likely he will survive.", "He has a 90% chance of surviving.", "He will definitely survive.")) + 
  theme_bw() + 
  stat_summary(fun.y=mean, geom="point", shape=4, size=3)


#--------------------------------

zier_box <- zier_tbl %>% 
  ggplot(aes(x = key, y = value)) + 
  geom_boxplot(fill = "aquamarine") + 
  coord_flip() +
  scale_y_continuous(limits = c(0, 100)) + 
  labs(title = "ICU Proxy Sample (Zier)", 
       y = "Likelihood of survival (%)", 
       x = "Prognostic statement") + 
  scale_x_discrete(labels = c("He will definitely not survive.", "He has a 5% chance of surviving.", "It is unlikely he will survive. That means he will likely die.", "It is very likely he will die.", "It is very unlikely he will survive.", "I don't think he will survive.", "He probably will not survive.", "It is possible he will not survive.", "I am concerned he will not survive.", "He has a 50% chance of surviving.", "I am optimistic he will survive.", "It is very unlikely he will die.", "I think he will survive.", "It is very likely he will survive.", "He has a 90% chance of surviving.", "He will definitely survive.")) + 
  theme_bw() + 
  stat_summary(fun.y=mean, geom="point", shape=4, size=3)


grid.arrange(copd_box, zier_box, nrow=2)

```


### THE TABLE FLIP ###
# A grand saga where emma flips tables as a consequence of social distancing and telework
# COPD summary table 
```{r summary_copd }

# Summary statistics 
select <- grepl("zier", colnames(zier_data)) 
copd_data[,select] <- apply(copd_data[,select], 2, as.numeric)
rm(select)

tab_ridge_tbl <- copd_data %>% 
  dplyr::select(zier_vars)

sum <- summary.data.frame(tab_ridge_tbl)



zier_data[,select] <- apply(zier_data[,select], 2, as.numeric)

tab_ridge_tbl2 <- zier_data %>% 
  dplyr::select(zier_vars)

sum2 <- summary.data.frame(tab_ridge_tbl2)
sum2





```
# 2-sample Tests
```{r ks_test }

zier_vars <- c("zier_1", "zier_2", "zier_3", "zier_4", "zier_5", "zier_6", "zier_7", "zier_8", "zier_9", "zier_10", "zier_11", "zier_12", "zier_13", "zier_14", "zier_15", "zier_16")

# KS TEST 

ks_func <- function (x) {
  ks.test(dplyr::filter(zier_tbl, key == x)[[2]], dplyr::filter(copd_tbl, key == x)[[2]]) # [[]] extracts element from list 
  a <- dplyr::filter(zier_tbl, key == x)$value
  b <- dplyr::filter(copd_tbl, key == x)$value
  model <- ks.test(a,b)

  d <- c("stat" = model$statistic, "p-val" = model$p.value)
}

ks_results <- sapply(zier_vars, ks_func)

#----------------------

# WILCOX TEST 
wc_func <- function (x) {
  wilcox.test(dplyr::filter(zier_tbl, key == x)[[2]], dplyr::filter(copd_tbl, key == x)[[2]]) 
  a <- dplyr::filter(zier_tbl, key == x)$value 
  b <- dplyr::filter(copd_tbl, key == x)$value 
  model <- wilcox.test(a,b) 
  
  d <- c("stat" = model$statistic, "p-val" = model$p.value)
}

wc_results <- sapply(zier_vars, wc_func)

#---------------------

#summtab <- read_csv(here::here("Data", "20200327_Summary Table Hack.csv"))

#summtab <- summtab %>% 
#  mutate('ks p.value' = as.numeric(results$stat)) %>% 
#  mutate('ks statistic' = as.numeric(results$p-val))




```





# Discarded pieces 
```{r}

# Create variables for median and IQR values (???)
ridge_tbl2 <- ridge_tbl %>% 
  mutate(median = ifelse(key == "zier_16", median((filter(ridge_tbl, key == "zier_16"))$value), NA)) %>%
  mutate(median = ifelse(key == "zier_15", median((filter(ridge_tbl, key == "zier_15"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_14", median((filter(ridge_tbl, key == "zier_14"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_13", median((filter(ridge_tbl, key == "zier_13"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_12", median((filter(ridge_tbl, key == "zier_12"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_11", median((filter(ridge_tbl, key == "zier_11"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_10", median((filter(ridge_tbl, key == "zier_10"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_9", median((filter(ridge_tbl, key == "zier_9"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_8", median((filter(ridge_tbl, key == "zier_8"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_7", median((filter(ridge_tbl, key == "zier_7"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_6", median((filter(ridge_tbl, key == "zier_6"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_5", median((filter(ridge_tbl, key == "zier_5"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_4", median((filter(ridge_tbl, key == "zier_4"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_3", median((filter(ridge_tbl, key == "zier_3"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_2", median((filter(ridge_tbl, key == "zier_2"))$value), median)) %>% 
  mutate(median = ifelse(key == "zier_1", median((filter(ridge_tbl, key == "zier_1"))$value), median)) 
  

```

